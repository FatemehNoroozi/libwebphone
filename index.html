<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<title></title>
		<meta name="description" content="">
		<meta name="viewport" content="width=device-width initial-scale=1.0">
		
		<link rel="stylesheet" href="lib/external/bootstrap.min.css">
		<link rel="stylesheet" href="lib/external/bootstrap-theme.min.css">
		<link rel="stylesheet" href="lib/external/toastr.min.css">
		<link rel="stylesheet" href="lib/external/font-awesome.min.css">
		<link rel="stylesheet" href="demo.css">
		
		<script src="lib/external/jquery-1.11.1.min.js"></script>
		<script src="lib/external/toastr.min.js"></script>
		<script src="lib/kazoo.js" type="text/javascript"></script>
		<script type="text/javascript">
			$(window).on('hashchange', function() {
				if(window.location.hash.substring(1) === 'help') { $('.help-box').show(); }
			});

			$(document).ready(function() {
				$('.logged-in').hide();
				$('#divCalling').hide();

				if(window.location.hash.substring(1) === 'help') { $('.help-box').show(); }

				if(window.location.search.substring(1) === 'demo') {
					$('#callBtn').on('click', function() {
						var destination = 'sip:'+$('#numberInput').val()+'@'+$('#realm').val();
						kazoo.connect(destination);
					});
				}

				$('#toggleLoginInfo').on('click', function() {
					$('.login-info').slideToggle();
				});

				$('.dialpad .touch-key').on('click', function() {
					var key = String($(this).data('key'));
					try {
						kazoo.sendDTMF(key);
					} catch(err) {
						$('#numberInput').val($('#numberInput').val()+key);
					}
				});
			});
		</script>
	</head>
	<body>
		<div class="info-box">
			<div class="conf-numbers">
				<div class="info-title">Conference Numbers:</div>
				<div class="conf-line">2600</div>
				<div class="conf-line">2601</div>
				<div class="conf-line">2602</div>
				<div class="conf-line">2603</div>
				<div class="conf-line">2604</div>
				<div class="conf-line">2605</div>
			</div>
			<div class="help-box">
				<div class="info-title">Enable "Call" button:</div>
				<ol>
					<li class="help-line">Open your web browser developer console
					<br>(<em>F12</em> or <em>right-click > inspect element</em>, then click on the <em>console</em> tab).</li>
					<li class="help-line">Copy the following block of code:</li>
<code>$('#callBtn').on('click', function() {
    var destination = 'sip:'+$('#numberInput').val()+'@'+$('#realm').val();
    kazoo.connect(destination);
});</code>
					<li class="help-line">Paste it in your web browser console.</li>
					<li class="help-line">Press Enter.</li>
					<li class="help-line">Type any of the conference number above using the dialpad.</li>
					<li class="help-line">Click on the "Call" button.</li>
				</ol>
				<br>
				<p>If you're lost or just lazy, you can get fully working demo <a href="?demo">here</a>.</p>
			</div>
		</div>

		<div class="login-div">
			<div class="logged-out">
				<button type="button" class="btn btn-primary btn-small" id="loginBtn" onclick="login()">Login</button>
				<a id="toggleLoginInfo">settings</a>
				<div class="login-info">
					<div>
						<span class="login-label">Private Identity:</span>
						<input class="login-input" type="text" id="privateIdentity" value="user_3333">
					</div>
					<div>
						<span class="login-label">Public Identity:</span>
						<input class="login-input" type="text" id="publicIdentity" value="sip:user_3333@webdev.realm">
					</div>
					<div>
						<span class="login-label">Password:</span>
						<input class="login-input" type="text" id="password" value="webdev">
					</div>
					<div>
						<span class="login-label">Realm:</span>
						<input class="login-input" type="text" id="realm" value="webdev.realm">
					</div>
				</div>
			</div>
			<div class="logged-in">
				<button type="button" class="btn btn-danger btn-small" id="logoutBtn" onclick="logout()">Logout</button>
			</div>
		</div>

		<div class="dialpad box logged-in">
			<button type="button" class="btn btn-info touch-key" data-key="1">1</button>
			<button type="button" class="btn btn-info touch-key" data-key="2">2</button>
			<button type="button" class="btn btn-info touch-key" data-key="3">3</button>
			<button type="button" class="btn btn-info touch-key" data-key="4">4</button>
			<button type="button" class="btn btn-info touch-key" data-key="5">5</button>
			<button type="button" class="btn btn-info touch-key" data-key="6">6</button>
			<button type="button" class="btn btn-info touch-key" data-key="7">7</button>
			<button type="button" class="btn btn-info touch-key" data-key="8">8</button>
			<button type="button" class="btn btn-info touch-key" data-key="9">9</button>
			<button type="button" class="btn btn-info touch-key" data-key="#">#</button>
			<button type="button" class="btn btn-info touch-key" data-key="0">0</button>
			<button type="button" class="btn btn-info touch-key" data-key="*">*</button>

			<input type="text" id="numberInput" />

			<button type="button" class="btn btn-danger action-btn" onclick="hangup()">Hangup</button>
			<button type="button" class="btn btn-success action-btn" id="callBtn">Call</button>
		</div>

		<div id="divCalling" class="box">
			<div class="call-progress-title">Call in progress...</div>
			<progress class="call-progress-bar" value="1"></progress>
			<button id="btnMute" type="button" class="btn btn-info touch-key" onClick="mute()" data-state="unmuted">
				<i class="fa fa-microphone"></i>
			</button>
		</div>
	
		<div id="popupOverlay"></div>
		<div id="popup">
			<div id="popupHeader"></div>
			<div id="popupContent"></div>
			<div id="popupActions">
				<button id="popupOkBtn">OK</button>
				<button id="popupCancelBtn">Cancel</button>
			</div>
		</div>

		<div id="flash_div">
		</div>

		<script>
			var paramsInit = {
				forceRTMP: false,
				flashContainer: 'flash_div',
				onLoaded: function() {
					
				},
				onFlashMissing: function(container) {
					container.innerHTML = 'This content requires the Adobe Flash Player. <a href=http://www.adobe.com/go/getflash/>Get Flash</a>';
					container.className = 'demo-flash-error';
				}
			};

			kazoo.init(paramsInit);

			function login(){
				var kazooParams = {
					wsUrl: 'ws://10.26.0.41:8080',
					rtmpUrl: 'rtmp://10.26.0.41/sip',
					realm: document.getElementById('realm').value,
					privateIdentity: document.getElementById('privateIdentity').value,
					publicIdentity: document.getElementById('publicIdentity').value,
					password: document.getElementById('password').value,
					onAccepted: onAccepted,
					onConnected: onConnected,
					onHangup: onHangup,
					onCancel: onCancel,
					onIncoming: onIncoming,
					onConnecting: onConnecting,
					onTransfer: onTransfer,
					onNotified: onNotified,
					onError: onError,
					reconnectMaxAttempts: 3, // Unlimited autoreconnect attempts
					reconnectDelay: 5000 // New autoreconnect attempt every 5 seconds
				};

				kazoo.register(kazooParams);
			}

			function onTransfer() {
				document.getElementById('divCalling').style.display = "none";
			}

			function onIncoming(call) {
				console.log('onIncoming', call);
				// var caller = call.callerName + (call.callerNumber ? ' ('+call.callerNumber+')' : '');
				// confirmPopup(caller + ' is calling you! Pick up the call?', call.accept, call.reject);
			}

			function onConnecting() {
				console.log('Connecting...');
			}

			function onHangup() {
				document.getElementById('divCalling').style.display = "none";
			}

			function onCancel(status) {
				var msg = 'Your call has been canceled';
				if(status && status.message) { msg += ': ' + status.message; }
				if(status && status.code) { msg += ' (' + status.code + ')'; }
				toastr.info(msg);
				closePopup();
			}

			function onAccepted() {
				document.getElementById('divCalling').style.display = "block";
			}

			function onConnected() {
				$('.logged-out').hide();
				$('.logged-in').show();
			}

			function onNotified(notification) {
				switch(notification.key) {
					case 'connectivity_notification': {
						if(notification.status === 'offline') {
							toastr.warning(notification.message);
						} else {
							toastr.info(notification.message);
						}
						break;
					}
					case 'reconnecting_notification': {
						toastr.info(notification.message + '('+notification.attempt+')');
						break;
					}
					default: {
						console.log(notification.message);
					}

				}
			}

			function onError(error) {
				toastr.error('ERROR: ' + error.message);
				closePopup();
				if(error.key === 'disconnected') {
					$('.logged-out').show();
					$('.logged-in').hide();

				}
			}


			/* UI Binding */
			function transfer() {
				var destination = document.getElementById('transferDestination').value;

				kazoo.transfer(destination);
			};

			function call() {
				var destination = document.getElementById('destination').value;

				kazoo.connect('sip:'+$('#numberInput').val()+'@'+$('#realm').val());
			}

			function hangup() {
				try { 
					kazoo.hangup();
				} catch(e) {
				} finally {
					$('#numberInput').val('');
				}
			}

			function mute() {
				var muteBtn = $('#btnMute');
				if(muteBtn.data('state') === 'unmuted') {
					// kazoo.muteMicrophone(true, function() {
						muteBtn.data('state', 'muted')
							   .toggleClass('active');
						muteBtn.find('i').toggleClass('fa-microphone', false)
										 .toggleClass('fa-microphone-slash', true);
					// });
				} else {
					// kazoo.muteMicrophone(false, function() {
						muteBtn.data('state', 'unmuted')
							   .toggleClass('active');
						muteBtn.find('i').toggleClass('fa-microphone', true)
										 .toggleClass('fa-microphone-slash', false);
					// });
				}
			}

			function logout() {
				kazoo.logout();

				
				$('.logged-out').show();
				$('.logged-in').hide();
				closePopup();
			}

			function sendDTMF(dtmf) {
				kazoo.sendDTMF(dtmf);
			}

			function confirmPopup(message, okCallback, cancelCallback, type) {
				var popupHeader = document.getElementById('popupHeader');

				document.getElementById('popupContent').innerHTML = message || "Confirm?";
				document.getElementById('popupOverlay').style.display = 'block';
				document.getElementById('popup').style.display = 'block';
				popupHeader.className = type || 'info';
				popupHeader.innerHTML = 'Confirm';

				document.getElementById('popupOkBtn').onclick = function() {
					closePopup();
					okCallback && okCallback();
				};
				document.getElementById('popupCancelBtn').onclick = function() {
					closePopup();
					cancelCallback && cancelCallback();
				};
			}

			function closePopup() {
				document.getElementById('popupOverlay').style.display = 'none';
				document.getElementById('popup').style.display = 'none';
				document.getElementById('popupContent').innerHTML = '';
				document.getElementById('popupOkBtn').onclick = function() {};
				document.getElementById('popupCancelBtn').onclick = function() {};
			}
		</script>
	</body>
</html>
